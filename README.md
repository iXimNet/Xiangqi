# Master Xiangqi（中国象棋）

基于 React + Vite 的中国象棋单机对弈与复盘工具，支持局面存档、历史播放以及 OpenAI 兼容 LLM 驱动的 AI 局面点评。棋局与历史通过后端数据库共享，不同用户可查看同一局面。

## 功能亮点
- 本地双人对弈：内置走子规则、防止“将帅对面”与兵过河横走等非法操作，轮流提示当前行棋方。
- 将军/杀棋/和棋判定：检测被将军、杀棋（绝杀）与无子可走的和棋，给出提示并自动结束对局。
- 历史与复盘：对局结束自动归档（最多保留 50 局），可选择历史记录按手数播放、跳转或逐手查看。
- AI 辅助点评：调用 OpenAI 兼容接口（模型可自定义）对当前局面给出 50 字以内的优势与威胁点评（中文输出）。
- 数据持久化/共享：当前对局、统计与历史存于后端 SQLite，REST API 提供跨用户共享视图。
- 现代界面：Tailwind CDN 快速样式化，适配移动端触控（禁用长按菜单、防止误触）。
- 回合绑定逻辑：首次打开正在进行的对局自动分配为当前行棋方（仅此一次），后续即使轮到对手也不切换本地身份；只能在自己回合落子，黑方视角下棋盘翻转（上红下黑）。

## 快速开始
**环境要求**：Node.js 18+，npm

1. 安装依赖  
   ```bash
   npm install
   ```
2. 配置环境变量：在 `.env.local` 设置 OpenAI 兼容 LLM 服务（AI 点评可选，但无 Key 时会提示缺失）  
   ```bash
   VITE_LLM_API_KEY=your_api_key
   VITE_LLM_API_BASE=https://api.openai.com/v1    # 可换为兼容服务地址
   VITE_LLM_MODEL=gpt-4o-mini                     # 可换为兼容模型名
   ```
   `vite.config.ts` 会将上述变量注入给前端调用。
   如需自定义后端业务地址，可设置：
   ```bash
   VITE_API_BASE_URL=http://your-host:4000/api
   ```
3. 启动后端 API（默认 http://localhost:4000）  
   ```bash
   npm run api
   ```
   若需自定义 API 地址，前端可通过 `VITE_API_BASE_URL` 配置：
   ```bash
   VITE_API_BASE_URL=http://your-host:4000/api
   ```
4. 启动前端开发服务器（默认 http://localhost:3000）  
   ```bash
   npm run dev
   ```
5. 生产构建与预览  
   ```bash
   npm run build
   npm run preview
   ```

> 提示：不要将真实 API Key 提交到仓库，建议使用环境管理或在提交前清理 `.env.local`。

## 目录结构
- `App.tsx`：应用入口，管理视图切换（对局/历史）、状态与业务流程。
- `components/Board.tsx` / `components/Piece.tsx`：棋盘渲染、选子/走子交互、落点提示与最近一步标记。
- `services/xiangiRules.ts`：走子规则校验、飞将判定、棋局重建与描述生成（供 AI 提问）。
- `services/storageService.ts`：前端 API 客户端，读取/写入后端对局、历史与统计。
- `services/aiService.ts`：封装 Gemini 调用，输入当前局面与最近着法生成点评。
- `constants.ts` / `types.ts`：棋盘尺寸、初始布局、文案与类型定义。
- `server.js`：Express + SQLite 的 REST API，负责对局/历史/统计存储与共享。

## 规则与数据说明
- 规则覆盖：各棋子合法步法 + “飞将”检测，过河兵横走；检测将军、杀棋（己方无合法解将即判输）、无子可走的逼和，并阻止依旧被将军的非法走法。
- 未覆盖：未实现长将/重复局三次和、五次重复、超时/认输判定，统计仍以结束标记为准；被将/杀的提示仅基于规则走法，不含复杂裁判条例。
- 和棋判定：目前仅覆盖“无合法走法且未被将军”的逼和场景。
- 数据存储：后端 `games` 表保存完整对局 JSON，预留行棋者信息字段（红/黑玩家 ID/姓名/头像）。

## 完成度评估
- ✅ 主要功能：本地双人对弈、合规走子校验、将军/杀棋/逼和判定、局面存档与历史复盘、AI 局面点评、后端数据库共享。
- ⚠️ 局限点：未做长将/重复局和棋判定、悔棋/认输/计时、玩家身份鉴权与权限控制；实时更新基于轮询，未使用推送。
- 🔒 安全性：仓库自带 `.env.local` 示例，提交代码前应移除真实 Key 并重新生成；API 尚未鉴权。

## 优化与后续升级建议
1. **完善规则引擎**：增加将军检测、杀棋判定、和棋（长将/重复局/无子可动）与合法性校验，避免玩家走出自陷将军的步。
2. **对局操作**：支持悔棋/重走、认输/和棋按钮、计时器与步时设置，并在统计中记录未完局与平局。
3. **多端与多人**：提供观战/远程对弈（WebSocket/信令）、房间与棋谱分享（FEN/PGN 风格），或导出标准棋谱。
4. **AI 能力**：增加开局库提示、连招建议与防守警报；允许选择模型/温度、限制 Token，或离线规则引擎备用。
5. **测试与质量**：为 `xiangiRules` 等核心规则添加单元测试与示例棋谱回放测试；引入 E2E（Playwright）覆盖交互。
6. **UI/体验**：国际化（中/英）、移动端震动反馈、更明显的可落点与合法性提示；可选 Tailwind 本地构建替代 CDN 以便离线与主题定制。
